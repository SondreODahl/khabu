# Docs for the Azure Web Apps Deploy action: https://go.microsoft.com/fwlink/?linkid=2134798
# More GitHub Actions for Azure: https://go.microsoft.com/fwlink/?linkid=2135048

name: Azure App Service - khabu(Production), Build and deploy Spring app

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # checkout the repo
    - name: 'Checkout Github Action'
      uses: actions/checkout@master


    - name: Set up Java version
      uses: actions/setup-java@v1
      with:
        java-version: '8'
        
    - name: Add node and maven
      run: |
        echo "Updating with apt..."
        apt update -y
        echo "Installing Node 12..."
        curl -sL https://deb.nodesource.com/setup_12.x | bash -
        apt install -y nodejs
        echo "Installing Yarn..."
        curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
        echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list
        apt install --no-install-recommends yarn
        echo "Installing maven..."
        apt install -y maven
        
    - name: Install front-end dependencies
      run: |
        echo "Installing dependencies..."
        cd front-end
        yarn
        
    - name: Build maven
      run: |
        echo "Testing..."
        ls
        yarn test --watchAll=false --passWithNoTests # NB NEED TO HAVE WATCHALL
        echo "Building..."
        yarn build
        cd ../back-end
        echo "Running Mvn clean install"
        mvn clean install
        
    - name: Run Azure webapp deploy action using publish profile credentials
      uses: azure/webapps-deploy@v2
      with:
        app-name: khabu
        slot-name: Production
        publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_603C5C06647B4029BA61349208DF4B11 }}
        package: ${{ github.workspace }}/target/*.jar

